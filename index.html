<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RENT. – Suivi abonnements</title>
  <meta name="theme-color" content="#0b0d10" />
  <link rel="manifest" href="manifest.webmanifest?v=4">
  <link rel="apple-touch-icon" href="icons/icon-180.png" />
  <style>
    :root{
      --bg: #0b0d10; --bg-2: #0f1217; --glass: rgba(255,255,255,0.06);
      --text:#e8ecf1; --muted:#9aa6b2; --accent:#ff3ea5; --accent-2:#6c5ce7;
      --shadow: 0 10px 30px rgba(0,0,0,.45); --radius:16px; --radius-xl:22px; --blur:20px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background: radial-gradient(1200px 800px at 90% -10%, rgba(255,62,165,.15), transparent 60%),
                  radial-gradient(1000px 700px at -10% 110%, rgba(108,92,231,.15), transparent 60%),
                  linear-gradient(180deg, var(--bg), var(--bg-2));
      background-attachment: fixed;
    }

    .app{max-width: 860px;margin-inline:auto;padding: clamp(16px, 3.5vw, 28px);display:flex;flex-direction:column;gap:16px}
    header{display:grid;gap:14px}
    .titlebar{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;row-gap:6px}
    .brand{display:flex;align-items:center;gap:10px;flex:1;min-width:0}
    .logo-text{font-size:clamp(20px,7vw,30px);font-weight:1000;letter-spacing:.4px;line-height:1.1;white-space:nowrap}
    .logo-text span{color:var(--accent);font-size:1.2em;line-height:1}

    .chip{display:inline-flex;align-items:center;gap:8px;padding:7px 12px;border-radius:999px;background:var(--glass);backdrop-filter:blur(var(--blur));-webkit-backdrop-filter:blur(var(--blur));box-shadow:var(--shadow), inset 0 0 0 1px rgba(255,255,255,.06);color:var(--muted);font-size:12px}

    .cards{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:680px){.cards{grid-template-columns:repeat(2,1fr)}}

    .glass{background:var(--glass);backdrop-filter:blur(var(--blur));-webkit-backdrop-filter:blur(var(--blur));border-radius:var(--radius-xl);box-shadow:var(--shadow), inset 0 0 0 1px rgba(255,255,255,.07)}

    .kpi{padding:16px;display:flex;flex-direction:column;gap:10px}
    .kpi h2{margin:0;font-size:13px;color:var(--muted);font-weight:600}
    .kpi .val{font-size:clamp(20px,6.5vw,32px);font-weight:800;line-height:1.2}

    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{cursor:pointer;border:0;color:var(--text);padding:10px 14px;border-radius:12px;background:var(--glass);backdrop-filter:blur(var(--blur));box-shadow:var(--shadow), inset 0 0 0 1px rgba(255,255,255,.07)}
    .btn.primary{background:linear-gradient(135deg, rgba(255,62,165,.4), rgba(108,92,231,.35))}

    .switch{display:inline-flex;align-items:center;gap:8px;padding:6px;border-radius:999px;background:var(--glass);box-shadow:var(--shadow), inset 0 0 0 1px rgba(255,255,255,.07)}
    .switch button{padding:8px 12px;border-radius:999px;border:0;background:transparent;color:var(--muted);font-weight:700;cursor:pointer}
    .switch button.active{color:var(--text);background:rgba(255,255,255,.1)}

    .section{display:flex;flex-direction:column;gap:10px}
    .section h3{margin:10px 4px 0;color:var(--muted);font-size:12px;text-transform:uppercase;letter-spacing:.9px}

    .item{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;padding:14px;border-radius:16px;background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));box-shadow:inset 0 0 0 1px rgba(255,255,255,.06)}
    .left{display:flex;align-items:center;gap:12px}
    .name{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .meta{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .amount{text-align:right}
    .amount .main{font-weight:800}
    .amount .sub{font-size:12px;color:var(--muted)}

    .actions{display:flex;gap:6px}
    .icon-btn{appearance:none;border:0;background:rgba(255,255,255,.08);color:var(--text);width:34px;height:34px;border-radius:10px;cursor:pointer;display:grid;place-items:center;box-shadow:inset 0 0 0 1px rgba(255,255,255,.06)}

    .fab{position:fixed;right:18px;bottom:18px;z-index:9999;padding:14px 18px;font-weight:800;background:linear-gradient(135deg, var(--accent), var(--accent-2));border:0;color:white;border-radius:20px;box-shadow:var(--shadow)}

    /* Overlay modal (no <dialog>, iOS-safe) */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(4px);display:none;align-items:flex-end;z-index:9998}
    .overlay.open{display:flex}
    .sheet{width:100%;max-width:860px;margin:0 auto;background:var(--glass);backdrop-filter:blur(var(--blur));border-radius:22px 22px 0 0;box-shadow:var(--shadow), inset 0 0 0 1px rgba(255,255,255,.07);padding:16px}

    @media (max-width:480px){
      .toolbar{width:100%;justify-content:flex-start}
      .switch{flex:1;min-width:0}
      .switch button{padding:8px 10px}
      .btn{padding:8px 10px}
      .chip{max-width:100%}
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <header>
      <div class="titlebar">
        <div class="brand"><div class="logo-text">RENT<span>.</span></div></div>
        <div class="toolbar">
          <div class="switch" role="tablist" aria-label="Filtre">
            <button id="tab-month" class="active" role="tab" aria-selected="true">Mensuel</button>
            <button id="tab-year" role="tab" aria-selected="false">Annuel</button>
          </div>
          <button id="btn-export" class="btn" title="Exporter JSON">Exporter</button>
          <button id="btn-import" class="btn" title="Importer JSON">Importer</button>
        </div>
      </div>

      <div class="cards">
        <div class="glass kpi" aria-live="polite">
          <h2>Total mensuel (équivalent)</h2>
          <div class="val" id="total-month">€0,00</div>
        </div>
        <div class="glass kpi" aria-live="polite">
          <h2>Total annuel</h2>
          <div class="val" id="total-year">€0,00</div>
        </div>
      </div>

      <div class="chip">Astuce: appuie long sur une carte pour éditer ✏️</div>
    </header>

    <main class="section" aria-live="polite">
      <h3>Mensuels</h3>
      <div id="list-month" class="section glass" style="padding:10px;">
        <div class="empty" id="empty-month" style="text-align:center;color:var(--muted);padding:24px">Aucun abonnement mensuel. Ajoute-en un ↓</div>
      </div>

      <h3>Annuels</h3>
      <div id="list-year" class="section glass" style="padding:10px;">
        <div class="empty" id="empty-year" style="text-align:center;color:var(--muted);padding:24px">Aucun abonnement annuel. Ajoute-en un ↓</div>
      </div>
    </main>

    <footer>RENT. • LocalStorage • PWA</footer>
  </div>

  <button class="fab" id="btn-add" aria-haspopup="dialog">+ Ajouter</button>

  <!-- Modal Add/Edit (custom overlay, iOS-safe) -->
  <div class="overlay" id="overlay" aria-hidden="true">
    <form class="sheet" id="form" aria-modal="true" role="dialog">
      <h2 id="modal-title" style="margin:6px 4px 12px;font-size:18px">Nouvel abonnement</h2>
      <input type="hidden" id="sub-id" />
      <div class="grid grid-2" style="display:grid;gap:12px;grid-template-columns:1fr 1fr">
        <label>Nom
          <input id="name" required placeholder="Netflix, Spotify, Adobe…" />
        </label>
        <label>Montant
          <input id="amount" type="number" min="0" step="0.01" required placeholder="9.99" />
        </label>
        <label>Périodicité
          <select id="period" required>
            <option value="month">Mensuel</option>
            <option value="year">Annuel</option>
          </select>
        </label>
        <label>Devise (symbole)
          <input id="currency" maxlength="3" placeholder="€" />
        </label>
        <label>Date de début (optionnel)
          <input id="start" type="date" />
        </label>
        <label>Catégorie (optionnel)
          <input id="category" placeholder="Streaming, Cloud…" />
        </label>
        <label style="grid-column:1/-1">Notes (optionnel)
          <textarea id="notes" rows="3" placeholder="Infos de facturation, comptes, etc."></textarea>
        </label>
      </div>
      <div class="actions" style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
        <button type="button" class="btn" id="btn-cancel">Annuler</button>
        <button type="submit" class="btn primary" id="btn-save">Enregistrer</button>
      </div>
    </form>
  </div>

  <input type="file" id="file-input" accept="application/json" style="position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0" />

  <script>
    // ------- PWA: Service worker (with cache-buster) --------
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js?v=4').then(r => r.update()).catch(console.error);
      });
    }

    // ---------------- App logic -----------------
    (function(){
      const $ = s=>document.querySelector(s);
      const app = $('#app');
      const overlay = $('#overlay');

      const state = { subs: [], currency: '€', view: 'month' }; // view: 'month' | 'year'
      const KEY = 'subs.v1';
      const load = () => { try{ const raw = localStorage.getItem(KEY); if(!raw) return; const data = JSON.parse(raw); if(Array.isArray(data.subs)) state.subs = data.subs; if(data.currency) state.currency = data.currency; } catch(e){} };
      const save = () => localStorage.setItem(KEY, JSON.stringify({ subs: state.subs, currency: state.currency }));
      const euro = v => Number((Math.round(v*100)/100).toFixed(2));
      const fmt = (n, cur=state.currency) => { try{ return new Intl.NumberFormat(navigator.language||'fr-FR',{style:'currency',currency:cur==='€'?'EUR':undefined,currencyDisplay:cur==='€'?'symbol':undefined,minimumFractionDigits:2}).format(n);}catch{ return (cur||'')+n.toFixed(2);} };
      const nextRenewal = (start, period) => { if(!start) return null; const now=new Date(); let d=new Date(start); if(isNaN(d)) return null; while(d<=now){ if(period==='month') d.setMonth(d.getMonth()+1); else d.setFullYear(d.getFullYear()+1);} return d; };

      // UI refs
      const listMonth = $('#list-month');
      const listYear = $('#list-year');
      const emptyMonth = $('#empty-month');
      const emptyYear = $('#empty-year');
      const totalMonth = $('#total-month');
      const totalYear = $('#total-year');

      // Modal
      const form = $('#form');
      const fields = { id: $('#sub-id'), name: $('#name'), amount: $('#amount'), period: $('#period'), currency: $('#currency'), start: $('#start'), category: $('#category'), notes: $('#notes') };

      const openModal = (sub=null) => {
        // reset
        form.reset(); fields.id.value=''; fields.currency.value = state.currency || '€';
        document.getElementById('modal-title').textContent = sub?"Modifier l'abonnement":"Nouvel abonnement";
        if(sub){
          fields.id.value=sub.id; fields.name.value=sub.name; fields.amount.value=String(sub.amount);
          fields.period.value=sub.period; fields.currency.value=sub.currency||state.currency;
          fields.start.value=sub.start||''; fields.category.value=sub.category||''; fields.notes.value=sub.notes||'';
        }
        overlay.classList.add('open'); overlay.setAttribute('aria-hidden','false');
        setTimeout(()=> fields.name.focus(), 50);
      };
      const closeModal = () => { overlay.classList.remove('open'); overlay.setAttribute('aria-hidden','true'); };

      // Item row
      const itemRow = (sub) => {
        const row = document.createElement('div'); row.className='item'; row.dataset.id=sub.id;
        const left=document.createElement('div'); left.className='left';
        const avatar=document.createElement('div'); avatar.style.width='38px'; avatar.style.height='38px'; avatar.style.borderRadius='12px'; avatar.style.background='linear-gradient(135deg, rgba(255,62,165,.25), rgba(108,92,231,.25))';
        const info=document.createElement('div');
        const name=document.createElement('div'); name.className='name'; name.textContent=sub.name;
        const meta=document.createElement('div'); meta.className='meta'; const nr=nextRenewal(sub.start, sub.period); meta.textContent=[sub.category, nr?`Prochain: ${nr.toLocaleDateString()}`:null].filter(Boolean).join(' • ');
        info.append(name, meta); left.append(avatar, info);

        const right=document.createElement('div'); right.className='amount';
        const main=document.createElement('div'); main.className='main'; main.textContent=`${fmt(sub.amount, sub.currency||state.currency)} / ${sub.period==='month'?'mois':'an'}`;
        const subline=document.createElement('div'); subline.className='sub'; const monthlyEq=sub.period==='month'?sub.amount:sub.amount/12; const yearlyEq=sub.period==='year'?sub.amount:sub.amount*12; subline.textContent=`≈ ${fmt(euro(monthlyEq), sub.currency||state.currency)} /mois • ${fmt(euro(yearlyEq), sub.currency||state.currency)} /an`;
        right.append(main, subline);

        const actions=document.createElement('div'); actions.className='actions';
        const edit=document.createElement('button'); edit.className='icon-btn'; edit.title='Modifier'; edit.textContent='✏️';
        const del=document.createElement('button'); del.className='icon-btn'; del.title='Supprimer'; del.textContent='🗑️';
        actions.append(edit, del);

        const wrap=document.createElement('div'); wrap.style.display='flex'; wrap.style.alignItems='center'; wrap.style.gap='8px'; wrap.append(right, actions);
        row.append(left, wrap);

        edit.addEventListener('click', ()=> openModal(sub));
        row.addEventListener('pointerdown', ()=>{ const t=setTimeout(()=>openModal(sub),520); const clear=()=>{clearTimeout(t); row.removeEventListener('pointerup',clear); row.removeEventListener('pointerleave',clear)}; row.addEventListener('pointerup',clear); row.addEventListener('pointerleave',clear); });
        del.addEventListener('click', ()=>{ if(confirm(`Supprimer ${sub.name} ?`)){ state.subs = state.subs.filter(s=>s.id!==sub.id); save(); render(); } });
        return row;
      };

      // Render + filter view
      const render = () => {
        listMonth.innerHTML=''; listYear.innerHTML='';
        const m = state.subs.filter(s=>s.period==='month');
        const y = state.subs.filter(s=>s.period==='year');
        if(!m.length) listMonth.append(emptyMonth); else emptyMonth.remove();
        if(!y.length) listYear.append(emptyYear); else emptyYear.remove();
        m.forEach(s=> listMonth.append(itemRow(s))); y.forEach(s=> listYear.append(itemRow(s)));
        const mTotal = euro(m.reduce((a,s)=> a+s.amount,0) + y.reduce((a,s)=> a+s.amount/12,0));
        const yTotal = euro(y.reduce((a,s)=> a+s.amount,0) + m.reduce((a,s)=> a+s.amount*12,0));
        totalMonth.textContent = fmt(mTotal); totalYear.textContent = fmt(yTotal);
        // filter visibility
        if(state.view==='month'){ listMonth.parentElement.style.display='block'; listYear.parentElement.style.display='none'; }
        else{ listMonth.parentElement.style.display='none'; listYear.parentElement.style.display='block'; }
      };

      // Toolbar actions
      document.getElementById('btn-export').addEventListener('click', ()=>{
        const blob=new Blob([JSON.stringify({subs:state.subs,currency:state.currency},null,2)],{type:'application/json'});
        const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='abonnements.json'; a.click(); URL.revokeObjectURL(url);
      });
      const fileInput = document.getElementById('file-input');
      document.getElementById('btn-import').addEventListener('click', ()=> fileInput.click());
      fileInput.addEventListener('change', async (e)=>{
        const file=e.target.files&&e.target.files[0]; if(!file) return; const text=await file.text();
        try{ const data=JSON.parse(text); if(Array.isArray(data.subs)) state.subs=data.subs; else throw new Error('Format invalide'); state.currency=data.currency||state.currency||'€'; save(); render(); }
        catch(err){ alert('Import impossible : '+err.message); }
        fileInput.value='';
      });

      // Switch filter
      const tabMonth=document.getElementById('tab-month');
      const tabYear=document.getElementById('tab-year');
      const setView = (v)=>{ state.view=v; if(v==='month'){ tabMonth.classList.add('active'); tabYear.classList.remove('active'); } else { tabYear.classList.add('active'); tabMonth.classList.remove('active'); } render(); };
      tabMonth.addEventListener('click', ()=> setView('month'));
      tabYear.addEventListener('click', ()=> setView('year'));

      // Add/Edit modal
      document.getElementById('btn-add').addEventListener('click', ()=> openModal());
      document.getElementById('btn-cancel').addEventListener('click', closeModal);
      overlay.addEventListener('click', (e)=>{ if(e.target===overlay) closeModal(); });
      form.addEventListener('submit', (e)=>{
        e.preventDefault();
        const sub={ id: fields.id.value||crypto.randomUUID(), name: fields.name.value.trim(), amount: Number(fields.amount.value), period: fields.period.value, currency: (fields.currency.value||state.currency||'€').trim(), start: fields.start.value||undefined, category: fields.category.value.trim()||undefined, notes: fields.notes.value.trim()||undefined };
        if(!sub.name || !isFinite(sub.amount)) return alert('Complète correctement le nom et le montant.');
        const idx=state.subs.findIndex(s=>s.id===sub.id); if(idx>-1) state.subs[idx]=sub; else state.subs.push(sub);
        state.currency=sub.currency||state.currency; save(); render(); closeModal();
      });

      // Boot
      load(); render();
    })();
  </script>
</body>
</html>
